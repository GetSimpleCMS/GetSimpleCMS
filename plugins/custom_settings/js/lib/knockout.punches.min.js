/*
 Knockout.Punches
 Enhanced binding syntaxes for Knockout 3+
 (c) Michael Best
 License: MIT (http://www.opensource.org/licenses/mit-license.php)
 Version 0.5.1
*/
(function(c){if("function"===typeof define&&define.amd)define(["lib/knockout"],c);else if("object"===typeof module){var g=require("knockout");c(g)}else c(window.ko)})(function(c){function g(a,b){return u(A(a),"preprocess",b)}function A(a){return"object"===typeof a?a:c.getBindingHandler(a)||(c.bindingHandlers[a]={})}function u(a,b,d){if(a[b]){var h=a[b];a[b]=function(a,b,c){if(a=h.call(this,a,b,c))return d.call(this,a,b,c)}}else a[b]=d;return a}function q(a){var b=c.bindingProvider.instance;if(b.preprocessNode){var d=
b.preprocessNode;b.preprocessNode=function(b){var c=d.call(this,b);c||(c=a.call(this,b));return c}}else b.preprocessNode=a}function C(a,b){var d=c.getBindingHandler;c.getBindingHandler=function(c){var e;return d(c)||(e=c.match(a))&&b(e,c)}}function v(a){if(-1===a.indexOf("|"))return a;var b=a.match(/"([^"\\]|\\.)*"|'([^'\\]|\\.)*'|\|\||[|:]|[^\s|:"'][^|:"']*[^\s|:"']|[^\s|:"']/g);if(b&&1<b.length){b.push("|");a=b[0];for(var d,c,e=!1,f=!1,B=1;c=b[B];++B)"|"===c?(e&&(":"===d&&(a+="undefined"),a+=")"),
e=f=!0):(f?a="ko.filters['"+c+"']("+a:e&&":"===c?(":"===d&&(a+="undefined"),a+=","):a+=c,f=!1),d=c}return a}function w(a){g(a,v)}function x(a,b,d){function h(d){e[d]&&(e[d]=function(e,h){var g=Array.prototype.slice.call(arguments,0);g[1]=function(){var b={};b[a]=h();return b};return c.bindingHandlers[b][d].apply(this,g)})}var e=c.utils.extend({},this);h("init");h("update");e.preprocess&&(e.preprocess=null);c.virtualElements.allowedBindings[b]&&(c.virtualElements.allowedBindings[d]=!0);return e}function r(a,
b){var d=c.getBindingHandler(a);if(d){var h=d.getNamespacedHandler||x;d.getNamespacedHandler=function(){return g(h.apply(this,arguments),b)}}}function D(a,b,d){if("{"!==a.charAt(0))return a;a=c.expressionRewriting.parseObjectLiteral(a);c.utils.arrayForEach(a,function(a){d(b+E+a.key,a.value)})}function n(a){g(a,D)}function m(a){return/^([$_a-z][$\w]*|.+(\.\s*[$_a-z][$\w]*|\[.+\]))$/i.test(a)?"function(_x,_y,_z){return("+a+")(_x,_y,_z);}":a}function s(a){g(a,m)}function p(a,b,d){a=A(a);a._propertyPreprocessors||
(u(a,"preprocess",M),a._propertyPreprocessors={});u(a._propertyPreprocessors,b,d)}function M(a,b,d){if("{"!==a.charAt(0))return a;a=c.expressionRewriting.parseObjectLiteral(a);var h=[],e=this._propertyPreprocessors||{};c.utils.arrayForEach(a,function(a){var b=a.key;a=a.value;e[b]&&(a=e[b](a,b,d));a&&h.push("'"+b+"':"+a)});return"{"+h.join(",")+"}"}function y(a){return function(b){return"function("+a+"){return("+b+");}"}}function F(a,b,d){function c(a){var f=a.match(/^([\s\S]*)}}([\s\S]*?)\{\{([\s\S]*)$/);
f?(c(f[1]),b(f[2]),d(f[3])):d(a)}if(a=a.match(/^([\s\S]*?)\{\{([\s\S]*)}}([\s\S]*)$/))b(a[1]),c(a[2]),b(a[3])}function t(a){return null==a?"":a.trim?a.trim():a.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")}function G(a){if(3===a.nodeType&&a.nodeValue&&-1!==a.nodeValue.indexOf("{{")&&"TEXTAREA"!=(a.parentNode||{}).nodeName){var b=[];F(a.nodeValue,function(a){a&&b.push(document.createTextNode(a))},function(d){d&&b.push.apply(b,N.wrapExpression(d,a))});if(b.length){if(a.parentNode){for(var d=0,c=b.length,
e=a.parentNode;d<c;++d)e.insertBefore(b[d],a);e.removeChild(a)}return b}}}function H(){q(G)}function I(a){if(1===a.nodeType&&a.attributes.length)for(var b=a.getAttribute(z),d=c.utils.arrayPushAll([],a.attributes),h=d.length,e=0;e<h;++e){var f=d[e];if(f.specified&&f.name!=z&&-1!==f.value.indexOf("{{")){var g=[],k="";F(f.value,function(a){a&&g.push('"'+a.replace(/"/g,'\\"')+'"')},function(a){a&&(k=a,g.push("ko.unwrap("+a+")"))});1<g.length&&(k='""+'+g.join("+"));if(k){var l=f.name.toLowerCase(),l=O.attributeBinding(l,
k,a)||J(l,k,a),b=b?b+(","+l):l;a.setAttribute(z,b);a.removeAttribute(f.name)}}}}function J(a,b,d){return c.getBindingHandler(a)?a+":"+b:"attr."+a+":"+b}function K(){q(I)}var l=c.unwrap,k=c.punches={utils:{addBindingPreprocessor:g,addNodePreprocessor:q,addBindingHandlerCreator:C,setBindingPreprocessor:g,setNodePreprocessor:q}};k.enableAll=function(){H();K();n("attr");n("css");n("event");n("style");c.bindingHandlers.checked.after.push("attr.value");w("text");w("html");r("attr",v);s("click");s("submit");
s("optionsAfterRender");r("event",m);p("template","beforeRemove",m);p("template","afterAdd",m);p("template","afterRender",m)};c.filters={uppercase:function(a){return String.prototype.toUpperCase.call(l(a))},lowercase:function(a){return String.prototype.toLowerCase.call(l(a))},"default":function(a,b){a=l(a);return"function"===typeof a?a:"string"===typeof a?""===t(a)?b:a:null==a||0==a.length?b:a},replace:function(a,b,d){return String.prototype.replace.call(l(a),b,d)},fit:function(a,b,d,c){a=l(a);if(b&&
(""+a).length>b)switch(d=""+(d||"..."),b-=d.length,a=""+a,c){case "left":return d+a.slice(-b);case "middle":return c=Math.ceil(b/2),a.substr(0,c)+d+a.slice(c-b);default:return a.substr(0,b)+d}else return a},json:function(a,b,d){return c.toJSON(a,d,b)},number:function(a){return(+l(a)).toLocaleString()}};k.textFilter={preprocessor:v,enableForBinding:w};var E=".";C(/([^\.]+)\.(.+)/,function(a,b){var d=a[1],h=c.bindingHandlers[d];if(h)return d=(h.getNamespacedHandler||x).call(h,a[2],d,b),c.bindingHandlers[b]=
d});k.namespacedBinding={defaultGetHandler:x,setDefaultBindingPreprocessor:r,addDefaultBindingPreprocessor:r,preprocessor:D,enableForBinding:n};k.wrappedCallback={preprocessor:m,enableForBinding:s};k.preprocessBindingProperty={setPreprocessor:p,addPreprocessor:p};var L=y("$data,$event");k.expressionCallback={makePreprocessor:y,eventPreprocessor:L,enableForBinding:function(a,b){b=Array.prototype.slice.call(arguments,1).join();g(a,y(b))}};c.bindingHandlers.on={getNamespacedHandler:function(a){a=c.getBindingHandler("event"+
E+a);return g(a,L)}};if(!c.virtualElements.allowedBindings.html){var P=c.bindingHandlers.html.update;c.bindingHandlers.html.update=function(a,b){if(8===a.nodeType){var d=l(b());null!=d?(d=c.utils.parseHtmlFragment(""+d),c.virtualElements.setDomNodeChildren(a,d)):c.virtualElements.emptyNode(a)}else P(a,b)};c.virtualElements.allowedBindings.html=!0}var N=k.interpolationMarkup={preprocessor:G,enable:H,wrapExpression:function(a,b){var c=b?b.ownerDocument:document,h=!0,e;a=t(a);var f=a[0],g=a[a.length-
1],k=[];if("#"===f){if("/"===g?e=a.slice(1,-1):(e=a.slice(1),h=!1),f=e.match(/^([^,"'{}()\/:[\]\s]+)\s+([^\s:].*)/))e=f[1]+":"+f[2]}else"/"!==f&&(e="{"===f&&"}"===g?"html:"+t(a.slice(1,-1)):"text:"+t(a));e&&k.push(c.createComment("ko "+e));h&&k.push(c.createComment("/ko"));return k}},z="data-bind",O=k.attributeInterpolationMarkup={preprocessor:I,enable:K,attributeBinding:J};return k});
